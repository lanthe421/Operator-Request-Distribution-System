# ๐ฏ Operator Request Distribution System

ะะธะฝะธ-CRM ัะธััะตะผะฐ ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะฐัะฟัะตะดะตะปะตะฝะธั ะฒัะพะดััะธั ะพะฑัะฐัะตะฝะธะน ะพั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะผะตะถะดั ะพะฟะตัะฐัะพัะฐะผะธ ั ััะตัะพะผ ะธั ะทะฐะณััะทะบะธ ะธ ะบะพะผะฟะตัะตะฝัะธะน.

## โจ ะัะพะฑะตะฝะฝะพััะธ

- ๐ค **ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต** - ะพะฑัะฐัะตะฝะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐะทะฝะฐัะฐัััั ะพะฟะตัะฐัะพัะฐะผ ะฝะฐ ะพัะฝะพะฒะต ะฒะตัะพะฒัั ะบะพัััะธัะธะตะฝัะพะฒ
- โ๏ธ **ะะตัะพััะฝะพััะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต** - ะพะฟะตัะฐัะพัั ั ะฑะพะปััะธะผ ะฒะตัะพะผ ะฟะพะปััะฐัั ะฑะพะปััะต ะพะฑัะฐัะตะฝะธะน
- ๐ **ะะพะฝััะพะปั ะทะฐะณััะทะบะธ** - ััะตั ัะตะบััะตะน ะทะฐะณััะทะบะธ ะธ ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ะปะธะผะธัะฐ ะบะฐะถะดะพะณะพ ะพะฟะตัะฐัะพัะฐ
- ๐ **ะะธะฑะบะฐั ะฝะฐัััะพะนะบะฐ** - ัะฐะทะฝัะต ะฒะตัะฐ ะดะปั ัะฐะทะฝัั ะธััะพัะฝะธะบะพะฒ ะพะฑัะฐัะตะฝะธะน
- ๐ **ะกัะฐัะธััะธะบะฐ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ** - ะผะพะฝะธัะพัะธะฝะณ ะทะฐะณััะทะบะธ ะธ ัะฐัะฟัะตะดะตะปะตะฝะธั
- ๐งช **Property-Based Testing** - ัะตััะธัะพะฒะฐะฝะธะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Hypothesis ะดะปั ะณะฐัะฐะฝัะธะธ ะบะพััะตะบัะฝะพััะธ

## ๐ ะัััััะน ััะฐัั

### ะะฐัะธะฐะฝั 1: Docker (ัะตะบะพะผะตะฝะดัะตััั)

```bash
# ะะปะพะฝะธัะพะฒะฐัั ัะตะฟะพะทะธัะพัะธะน
git clone <repository-url>
cd operator-request-distribution

# ะะฐะฟัััะธัั ั Docker Compose
docker-compose up -d

# ะัะพะฒะตัะธัั ััะฐััั
docker-compose logs -f
```

ะกะตัะฒะตั ะฑัะดะตั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: **http://localhost:8000**

๐ ะะพะดัะพะฑะฝะตะต: [DOCKER_GUIDE.md](DOCKER_GUIDE.md)

### ะะฐัะธะฐะฝั 2: ะะพะบะฐะปัะฝะฐั ัััะฐะฝะพะฒะบะฐ

```bash
# ะะปะพะฝะธัะพะฒะฐัั ัะตะฟะพะทะธัะพัะธะน
git clone <repository-url>
cd operator-request-distribution

# ะฃััะฐะฝะพะฒะธัั ะทะฐะฒะธัะธะผะพััะธ
pip install -r requirements.txt

# ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั
alembic upgrade head

# ะะฐะฟัััะธัั ัะตัะฒะตั
python main.py
```

ะกะตัะฒะตั ะฑัะดะตั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: **http://localhost:8000**

### ะะฝัะตัะฐะบัะธะฒะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

ะัะบัะพะนัะต ะฒ ะฑัะฐัะทะตัะต: **http://localhost:8000/docs**

## ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### 1. ะกะพะทะดะฐะนัะต ะพะฟะตัะฐัะพัะพะฒ

```python
import requests

response = requests.post(
    "http://localhost:8000/api/v1/operators",
    json={
        "name": "ะะฒะฐะฝ ะะตััะพะฒ",
        "max_load_limit": 10
    }
)
```

### 2. ะกะพะทะดะฐะนัะต ะธััะพัะฝะธะบะธ ะพะฑัะฐัะตะฝะธะน

```python
response = requests.post(
    "http://localhost:8000/api/v1/sources",
    json={
        "name": "Telegram Bot",
        "identifier": "telegram"
    }
)
```

### 3. ะะฐัััะพะนัะต ะฒะตัะฐ ะพะฟะตัะฐัะพัะพะฒ

```python
response = requests.post(
    "http://localhost:8000/api/v1/sources/1/operators",
    json={
        "weights": [
            {"operator_id": 1, "weight": 50},
            {"operator_id": 2, "weight": 30},
            {"operator_id": 3, "weight": 20}
        ]
    }
)
```

### 4. ะกะพะทะดะฐะนัะต ะพะฑัะฐัะตะฝะธะต

```python
response = requests.post(
    "http://localhost:8000/api/v1/requests",
    json={
        "user_identifier": "user@example.com",
        "source_id": 1,
        "message": "ะะดัะฐะฒััะฒัะนัะต! ะัะถะฝะฐ ะฟะพะผะพัั"
    }
)
# ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐะทะฝะฐัะธั ะพะฟะตัะฐัะพัะฐ!
```

### 5. ะัะพัะผะพััะธัะต ััะฐัะธััะธะบั

```python
# ะะฐะณััะทะบะฐ ะพะฟะตัะฐัะพัะพะฒ
response = requests.get("http://localhost:8000/api/v1/stats/operators-load")

# ะะฐัะฟัะตะดะตะปะตะฝะธะต ะพะฑัะฐัะตะฝะธะน
response = requests.get("http://localhost:8000/api/v1/stats/requests-distribution")
```

## ๐๏ธ ะััะธัะตะบัััะฐ

ะกะธััะตะผะฐ ะฟะพัััะพะตะฝะฐ ะฝะฐ ััะตััะปะพะนะฝะพะน ะฐััะธัะตะบัััะต:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         API Layer (FastAPI)         โ
โ  - Request validation (Pydantic)    โ
โ  - Response serialization           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        Service Layer                โ
โ  - Business logic                   โ
โ  - Distribution algorithm           โ
โ  - Transaction management           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Repository Layer               โ
โ  - Data access (SQLAlchemy)         โ
โ  - Query optimization               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Database (SQLite)              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะปะณะพัะธัะผ ัะฐัะฟัะตะดะตะปะตะฝะธั

ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั ะผะตัะพะด **ะฝะฐะบะพะฟะธัะตะปัะฝัั ะฒะตัะพะฒ** (cumulative weights) ะดะปั ะฒะตัะพััะฝะพััะฝะพะณะพ ะฒัะฑะพัะฐ:

1. ะัะฑะธัะฐัััั ะดะพัััะฟะฝัะต ะพะฟะตัะฐัะพัั (`is_active=True`, `current_load < max_load_limit`, ะตััั ะฒะตั ะดะปั ะธััะพัะฝะธะบะฐ)
2. ะััะธัะปัะตััั ััะผะผะฐ ะฒัะตั ะฒะตัะพะฒ
3. ะะตะฝะตัะธััะตััั ัะปััะฐะนะฝะพะต ัะธัะปะพ ะพั 0 ะดะพ ััะผะผั ะฒะตัะพะฒ
4. ะัะฑะธัะฐะตััั ะพะฟะตัะฐัะพั, ัะตะน ะดะธะฐะฟะฐะทะพะฝ ัะพะดะตัะถะธั ััะพ ัะธัะปะพ

**ะัะธะผะตั:**
- ะะฟะตัะฐัะพั A: ะฒะตั 50 โ ะฒะตัะพััะฝะพััั 50%
- ะะฟะตัะฐัะพั B: ะฒะตั 30 โ ะฒะตัะพััะฝะพััั 30%
- ะะฟะตัะฐัะพั C: ะฒะตั 20 โ ะฒะตัะพััะฝะพััั 20%

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

ะัะพะตะบั ะฒะบะปััะฐะตั ะบะพะผะฟะปะตะบัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต:

### ะะฐะฟััะบ ะฒัะตั ัะตััะพะฒ

```bash
pytest -v
```

### ะขะธะฟั ัะตััะพะฒ

- **Unit Tests** - ัะตััะธัะพะฒะฐะฝะธะต ะพัะดะตะปัะฝัั ะบะพะผะฟะพะฝะตะฝัะพะฒ
- **Integration Tests** - ัะตััะธัะพะฒะฐะฝะธะต API endpoints
- **Property-Based Tests** - ัะตััะธัะพะฒะฐะฝะธะต ั Hypothesis (100+ ะธัะตัะฐัะธะน ะฝะฐ ัะฒะพะนััะฒะพ)

### Property-Based Testing

ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั [Hypothesis](https://hypothesis.readthedocs.io/) ะดะปั ะฟัะพะฒะตัะบะธ 30 ะบะพััะตะบัะฝัั ัะฒะพะนััะฒ:

- ะะฝะธัะธะฐะปะธะทะฐัะธั ะพะฟะตัะฐัะพัะพะฒ
- ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
- ะะฐัะฟัะตะดะตะปะตะฝะธะต ะพะฑัะฐัะตะฝะธะน
- ะกัะฐัะธััะธัะตัะบะธะต ัะฒะพะนััะฒะฐ
- ะฆะตะปะพััะฝะพััั ะดะฐะฝะฝัั

```bash
# ะะฐะฟัััะธัั ัะพะปัะบะพ property-based ัะตััั
pytest tests/property/ -v
```

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
.
โโโ app/
โ   โโโ api/v1/          # API endpoints
โ   โโโ models/          # SQLAlchemy ะผะพะดะตะปะธ
โ   โโโ schemas/         # Pydantic ััะตะผั
โ   โโโ services/        # ะะธะทะฝะตั-ะปะพะณะธะบะฐ
โ   โโโ repositories/    # ะะพัััะฟ ะบ ะดะฐะฝะฝัะผ
โ   โโโ core/            # ะะพะฝัะธะณััะฐัะธั
โ   โโโ utils/           # ะฃัะธะปะธัั
โโโ tests/
โ   โโโ unit/            # Unit ัะตััั
โ   โโโ integration/     # Integration ัะตััั
โ   โโโ property/        # Property-based ัะตััั
โโโ alembic/             # ะะธะณัะฐัะธะธ ะะ
โโโ .kiro/specs/         # ะกะฟะตัะธัะธะบะฐัะธะธ
โโโ main.py              # ะขะพัะบะฐ ะฒัะพะดะฐ
โโโ requirements.txt     # ะะฐะฒะธัะธะผะพััะธ
โโโ README.md
```

## ๐๏ธ ะขะตัะฝะพะปะพะณะธะธ

- **FastAPI** - ัะพะฒัะตะผะตะฝะฝัะน ะฒะตะฑ-ััะตะนะผะฒะพัะบ
- **SQLAlchemy** - ORM ะดะปั ัะฐะฑะพัั ั ะะ
- **Alembic** - ะผะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั
- **Pydantic** - ะฒะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
- **Hypothesis** - property-based testing
- **pytest** - ัะตััะธัะพะฒะฐะฝะธะต
- **SQLite** - ะฑะฐะทะฐ ะดะฐะฝะฝัั (ะปะตะณะบะพ ะทะฐะผะตะฝะธัั ะฝะฐ PostgreSQL)
- **Docker** - ะบะพะฝัะตะนะฝะตัะธะทะฐัะธั ะฟัะธะปะพะถะตะฝะธั

## ๐ API Endpoints

### ะะฟะตัะฐัะพัั
- `POST /api/v1/operators` - ัะพะทะดะฐัั ะพะฟะตัะฐัะพัะฐ
- `GET /api/v1/operators` - ัะฟะธัะพะบ ะพะฟะตัะฐัะพัะพะฒ
- `PUT /api/v1/operators/{id}` - ะพะฑะฝะพะฒะธัั ะพะฟะตัะฐัะพัะฐ
- `PUT /api/v1/operators/{id}/toggle-active` - ะฐะบัะธะฒะธัะพะฒะฐัั/ะดะตะฐะบัะธะฒะธัะพะฒะฐัั

### ะััะพัะฝะธะบะธ
- `POST /api/v1/sources` - ัะพะทะดะฐัั ะธััะพัะฝะธะบ
- `GET /api/v1/sources` - ัะฟะธัะพะบ ะธััะพัะฝะธะบะพะฒ
- `POST /api/v1/sources/{id}/operators` - ะฝะฐัััะพะธัั ะฒะตัะฐ

### ะะฑัะฐัะตะฝะธั
- `POST /api/v1/requests` - ัะพะทะดะฐัั ะพะฑัะฐัะตะฝะธะต (ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต)
- `GET /api/v1/requests` - ัะฟะธัะพะบ ะพะฑัะฐัะตะฝะธะน
- `GET /api/v1/requests/{id}` - ะดะตัะฐะปะธ ะพะฑัะฐัะตะฝะธั

### ะกัะฐัะธััะธะบะฐ
- `GET /api/v1/stats/operators-load` - ะทะฐะณััะทะบะฐ ะพะฟะตัะฐัะพัะพะฒ
- `GET /api/v1/stats/requests-distribution` - ัะฐัะฟัะตะดะตะปะตะฝะธะต ะพะฑัะฐัะตะฝะธะน

## ๐ง ะะพะฝัะธะณััะฐัะธั

ะกะพะทะดะฐะนัะต ัะฐะนะป `.env`:

```env
DATABASE_URL=sqlite:///./crm.db
API_V1_PREFIX=/api/v1
DEBUG=False
HOST=0.0.0.0
PORT=8000
```

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

ะกะธััะตะผะฐ ะฒะบะปััะฐะตั ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต ะธะฝะดะตะบัั ะดะปั ะฑัััััั ะทะฐะฟัะพัะพะฒ:

- ะะพะผะฟะพะทะธัะฝัะน ะธะฝะดะตะบั ะฝะฐ `operators(is_active, current_load)`
- ะะฝะดะตะบั ะฝะฐ `operator_source_weights(source_id)`
- ะะพะผะฟะพะทะธัะฝัะน ะธะฝะดะตะบั ะฝะฐ `requests(operator_id, source_id, status)`
- ะะฝะดะตะบั ะฝะฐ `users(identifier)`

## ๐ณ Docker

### ะัััััะน ะทะฐะฟััะบ

```bash
# ะะฐะฟัััะธัั
docker-compose up -d

# ะััะฐะฝะพะฒะธัั
docker-compose down

# ะะพะณะธ
docker-compose logs -f
```

### ะะพะผะฐะฝะดั ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ

```bash
# ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธะธ
docker-compose exec app alembic upgrade head

# ะะฐะฟัััะธัั ัะตััั
docker-compose exec app pytest -v

# ะัะบัััั bash
docker-compose exec app bash
```

๐ ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ: [DOCKER_GUIDE.md](DOCKER_GUIDE.md)

## ๐ค ะะฐะทัะฐะฑะพัะบะฐ

### ะกะพะทะดะฐะฝะธะต ะผะธะณัะฐัะธะธ

```bash
alembic revision --autogenerate -m "Description"
alembic upgrade head
```

### ะะฐะฟััะบ ะฒ ัะตะถะธะผะต ัะฐะทัะฐะฑะพัะบะธ

```bash
uvicorn main:app --reload
```

### ะะตะผะพ-ัะบัะธะฟัั

```bash
# ะะพะบะฐะทะฐัั ััะฐััั ัะธััะตะผั
python show_status.py

# ะััััะฐั ะดะตะผะพะฝัััะฐัะธั
python quick_demo.py

# ะะพะปะฝะฐั ะดะตะผะพะฝัััะฐัะธั
python demo_final.py

# ะะฐัััะพะนะบะฐ ะดะตะผะพ-ะดะฐะฝะฝัั
python setup_demo.py
```

## ๐ ะะพะบัะผะตะฝัะฐัะธั

- **START_HERE.md** - ะฑัััััะน ััะฐัั
- **USAGE_GUIDE_RU.md** - ะฟะพะดัะพะฑะฝะพะต ััะบะพะฒะพะดััะฒะพ
- **DEMO_COMPLETE.md** - ะฟัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั
- **.kiro/specs/** - ะฟะพะปะฝะฐั ัะฟะตัะธัะธะบะฐัะธั ะฟัะพะตะบัะฐ

## ๐ฏ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะฐััะพะฒะพะต ัะพะทะดะฐะฝะธะต ะพะฑัะฐัะตะฝะธะน

```python
for i in range(10):
    requests.post(
        "http://localhost:8000/api/v1/requests",
        json={
            "user_identifier": f"user{i}@example.com",
            "source_id": 1,
            "message": f"ะะฑัะฐัะตะฝะธะต #{i}"
        }
    )
```

### ะะพะฝะธัะพัะธะฝะณ ะฟะตัะตะณััะทะบะธ

```python
response = requests.get("http://localhost:8000/api/v1/stats/operators-load")
for op in response.json():
    if op['load_percentage'] > 80:
        print(f"โ๏ธ ะะฟะตัะฐัะพั {op['operator_name']} ะฟะตัะตะณััะถะตะฝ!")
```

### ะะธะฝะฐะผะธัะตัะบะฐั ะฑะฐะปะฐะฝัะธัะพะฒะบะฐ

```python
# ะฃะฒะตะปะธัะธัั ะปะธะผะธั ะฟะตัะตะณััะถะตะฝะฝะพะณะพ ะพะฟะตัะฐัะพัะฐ
requests.put(
    "http://localhost:8000/api/v1/operators/1",
    json={"max_load_limit": 20}
)
```

## ๐ ะะธัะตะฝะทะธั

MIT License

## ๐จโ๐ป ะะฒัะพั

ะะฐะทัะฐะฑะพัะฐะฝะพ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ัะฟะตัะธัะธะบะฐัะธะน ะธ property-based testing ะดะปั ะณะฐัะฐะฝัะธะธ ะบะพััะตะบัะฝะพััะธ.

---

**ะะพะบัะผะตะฝัะฐัะธั API:** http://localhost:8000/docs

**ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ:** [USAGE_GUIDE_RU.md](USAGE_GUIDE_RU.md)
